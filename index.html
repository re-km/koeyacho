<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>koeyacho</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">
    <style>
        :root {
            /* é…è‰²ãƒ†ãƒ¼ãƒï¼ˆVS Code Lightç³»ï¼‰ */
            --bg-color: #f3f3f3;
            --text-color: #333333;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --accent-color: #007acc;
            /* VS Code Blue */
            --accent-hover: #005f9e;
            --success-color: #16825d;
            --warning-color: #ea5c00;
            --error-color: #d13438;
            --sub-text: #666666;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 1.2em;
            color: var(--text-color);
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* å…±é€šã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        /* è¨­å®šã‚«ãƒ¼ãƒ‰ï¼ˆé–‹é–‰å¼ï¼‰ */
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 5px 0;
        }

        .settings-title {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--sub-text);
        }

        .settings-body {
            display: none;
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .settings-body.open {
            display: block;
        }

        .input-text {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
            margin-bottom: 10px;
            background: #fafafa;
        }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        button {
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }

        button:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            padding: 8px 16px;
            font-weight: 600;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            font-weight: 600;
        }

        .btn-danger {
            background: #fff;
            border: 1px solid var(--error-color);
            color: var(--error-color);
            padding: 4px 8px;
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 12px;
        }

        /* ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ */
        .select-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        select,
        input[type="number"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #fff;
            color: var(--text-color);
            font-size: 1em;
        }

        .flex-grow {
            flex: 1;
        }

        /* ã‚·ãƒ¼ãƒˆè¡¨ç¤º */
        .sheet-badge {
            display: inline-block;
            background: #e1f0fa;
            color: var(--accent-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* éŸ³å£°å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-card {
            text-align: center;
            border-left: 4px solid var(--accent-color);
        }

        .mic-btn {
            width: 100%;
            padding: 20px;
            background: var(--accent-color);
            color: white;
            font-size: 1.2em;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 122, 204, 0.2);
        }

        .mic-btn.listening {
            background: var(--error-color);
            box-shadow: 0 0 15px rgba(209, 52, 56, 0.4);
        }

        .result-box {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .recognized-text {
            color: var(--sub-text);
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .parsed-result {
            font-weight: bold;
            font-size: 1.1em;
        }

        .parsed-info span {
            margin: 0 5px;
        }

        .tag {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            color: white;
        }

        .tag-member {
            background: #444;
        }

        .tag-damage {
            background: var(--accent-color);
        }

        .tag-dim {
            background: var(--success-color);
        }

        /* ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
        }

        .list-title {
            font-weight: 600;
            font-size: 1em;
        }

        /* åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .sync-alert {
            background: #fff4e5;
            border: 1px solid var(--warning-color);
            color: #663c00;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            display: none;
            /* åˆæœŸéè¡¨ç¤º */
        }

        .sync-btn {
            background: var(--warning-color);
            color: white;
            font-size: 0.9em;
            padding: 6px 12px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            text-align: left;
            color: var(--sub-text);
            font-weight: normal;
            font-size: 0.8em;
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 8px 5px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .status-icon {
            font-size: 0.8em;
            margin-right: 4px;
        }

        .status-ok {
            color: var(--success-color);
        }

        .status-wait {
            color: var(--warning-color);
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer {
            text-align: center;
            color: var(--sub-text);
            font-size: 0.75em;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>koeyacho</h1>

    <!-- æœªé€ä¿¡ã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div id="syncAlert" class="sync-alert">
        <span>âš ï¸ æœªé€ä¿¡ãƒ‡ãƒ¼ã‚¿: <strong id="unsentCount">0</strong>ä»¶</span>
        <button class="sync-btn" onclick="syncAllData()">ã‚¯ãƒ©ã‚¦ãƒ‰ã«åŒæœŸ</button>
    </div>

    <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
    <div class="card">
        <div class="settings-header" onclick="toggleSettings()">
            <span class="settings-title">âš™ï¸ è¨­å®š (GAS URL & æ©‹é¸æŠ)</span>
            <span style="font-size:0.8em">â–¼</span>
        </div>
        <div class="settings-body" id="settingsBody">
            <label style="font-size:0.8em; display:block; margin-bottom:5px;">GAS Web App URL</label>
            <input type="text" class="input-text" id="gasUrl" placeholder="https://script.google.com/..."
                onchange="saveConfig()">
            <div style="font-size:0.8em; color:var(--sub-text); margin-top:5px;">
                æ©‹ãƒªã‚¹ãƒˆå–å¾—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="connectionStatus">æœªæ¥ç¶š</span>
            </div>
            <hr style="margin:15px 0; border:none; border-top:1px solid #eee;">
            <button class="btn-outline" style="width:100%; font-size:0.9em" onclick="window.location.reload(true)">â†»
                ã‚¢ãƒ—ãƒªã‚’å†èª­ã¿è¾¼ã¿ (æ›´æ–°)</button>
        </div>
    </div>

    <!-- æ©‹ãƒ»å ´æ‰€é¸æŠ -->
    <div class="card">
        <div class="select-row">
            <select id="bridgeSelect" class="flex-grow">
                <option value="">æ©‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <button class="btn-outline" onclick="fetchBridgeList()">ğŸ”„</button>
        </div>
        <div class="select-row">
            <select id="partSelect" class="flex-grow">
                <option value="ä¸‹é¢">ä¸‹é¢</option>
                <option value="ä¸‹éƒ¨å·¥">ä¸‹éƒ¨å·¥</option>
                <option value="æ”¯æ‰¿éƒ¨">æ”¯æ‰¿éƒ¨</option>
                <option value="æ©‹é¢">æ©‹é¢</option>
                <option value="ãƒˆãƒ©ã‚¹ãƒ»ã‚¢ãƒ¼ãƒ">ãƒˆãƒ©ã‚¹ãƒ»ã‚¢ãƒ¼ãƒ</option>
            </select>
            <input type="number" id="spanInput" placeholder="å¾„é–“" style="width: 80px;">
        </div>
        <div style="text-align:right;">
            <span class="sheet-badge">Sheet: <span id="currentSheetName">ä¸‹é¢</span></span>
        </div>
    </div>

    <!-- éŸ³å£°å…¥åŠ› -->
    <div class="card input-card">
        <div class="result-box">
            <div id="recognizedText" class="recognized-text">å¾…æ©Ÿä¸­...</div>
            <div id="parsedResult" class="parsed-result"></div>
        </div>

        <!-- æ‰‹å‹•å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="manualInput" class="input-text" style="margin-bottom:0"
                placeholder="ä¾‹: åºŠç‰ˆã€ã²ã³å‰²ã‚Œã€L0.5">
            <button id="manualParseBtn" class="btn-outline">è§£æ</button>
        </div>

        <button id="micBtn" class="mic-btn">ğŸ™ï¸ éŸ³å£°å…¥åŠ›</button>
        <button id="addBtn" class="btn-success" style="width:100%; display:none;">âœ“ è¨˜éŒ²ã™ã‚‹</button>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ -->
    <div class="card">
        <div class="list-header">
            <span class="list-title">è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ (<span id="dataCount">0</span>)</span>
            <div>
                <button class="btn-outline" style="font-size:0.8em" onclick="downloadCSV()">CSV</button>
                <button class="btn-outline" style="font-size:0.8em; color:var(--error-color);"
                    onclick="clearAllData()">ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
        <div class="table-container">
            <table id="dataTable">
                <tbody id="dataBody"></tbody>
            </table>
            <div id="emptyState" style="text-align:center; padding:20px; color:var(--sub-text);">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
        </div>
    </div>

    <div class="footer" id="systemStatus">v1.3 (Manual Input) | Ready</div>

    <script>
        // ==========================================
        // ã‚³ãƒ³ãƒ•ã‚£ã‚° & ã‚¹ãƒ†ãƒ¼ãƒˆ
        // ==========================================
        let config = {
            gasUrl: localStorage.getItem('gasUrl') || '',
            bridges: JSON.parse(localStorage.getItem('bridges') || '[]'),
            currentBridgeId: localStorage.getItem('currentBridgeId') || ''
        };

        let appState = {
            data: [], // { id, timestamp, bridgeId, sheetName, content, ... , synced: boolean }
            currentParsed: null
        };

        // ==========================================
        // è¾æ›¸ãƒ‡ãƒ¼ã‚¿ (å¤‰æ›´ãªã—)
        // ==========================================
        const damageTypes = {
            1: "è…é£Ÿ", 2: "äº€è£‚", 3: "ã‚†ã‚‹ã¿ãƒ»è„±è½", 4: "ç ´æ–­", 5: "é˜²é£Ÿæ©Ÿèƒ½ã®åŠ£åŒ–", 6: "ã²ã³ã‚ã‚Œ", 7: "å‰¥é›¢ãƒ»é‰„ç­‹éœ²å‡º", 8: "æ¼æ°´ãƒ»éŠé›¢çŸ³ç°", 9: "æŠœã‘è½ã¡", 10: "è£œä¿®è£œå¼·æã®æå‚·", 11: "åºŠç‰ˆã²ã³ã‚ã‚Œ", 12: "ã†ã", 13: "éŠé–“ã®ç•°å¸¸", 14: "è·¯é¢ã®å‡¹å‡¸", 15: "èˆ—è£…ã®ç•°å¸¸", 16: "æ”¯æ‰¿éƒ¨ã®æ©Ÿèƒ½éšœå®³", 17: "ãã®ä»–", 18: "å®šç€éƒ¨ã®ç•°å¸¸", 19: "å¤‰è‰²ãƒ»åŠ£åŒ–", 20: "æ¼æ°´ãƒ»æ»æ°´", 21: "ç•°å¸¸ãªéŸ³ãƒ»æŒ¯å‹•", 22: "ç•°å¸¸ãªãŸã‚ã¿", 23: "å¤‰å½¢ãƒ»æ¬ æ", 24: "åœŸç ‚è©°ã¾ã‚Š", 25: "æ²ˆä¸‹ãƒ»ç§»å‹•ãƒ»å‚¾æ–œ", 26: "æ´—æ˜"
        };
        const damageKeywords = [
            { name: "è…é£Ÿ", aliases: ["ãµã—ã‚‡ã", "ã‚µãƒ“", "éŒ†", "ã•ã³"], id: 1 },
            { name: "äº€è£‚", aliases: ["ãã‚Œã¤", "ã‚¯ãƒ©ãƒƒã‚¯", "ã‚ã‚Œ", "å‰²ã‚Œ"], id: 2 },
            { name: "ã²ã³ã‚ã‚Œ", aliases: ["ã²ã³å‰²ã‚Œ", "ã‚¯ãƒ©ãƒƒã‚¯", "ã²ã³", "ãƒ’ãƒ“"], id: 6 },
            { name: "ã†ã", aliases: ["æµ®ã", "ã‚¦ã‚­"], id: 12 },
            { name: "å‰¥é›¢ãƒ»é‰„ç­‹éœ²å‡º", aliases: ["ã¯ãã‚Š", "å‰¥é›¢", "é‰„ç­‹éœ²å‡º", "éœ²å‡º"], id: 7 },
            { name: "éŠé–“ã®ç•°å¸¸", aliases: ["ã‚†ã†ã‹ã‚“", "éŠé–“", "ã™ãã¾"], id: 13 },
            { name: "æ¼æ°´ãƒ»éŠé›¢çŸ³ç°", aliases: ["ã‚ã†ã™ã„", "æ¼æ°´", "éŠé›¢çŸ³ç°", "ã‚¨ãƒ•ãƒ­", "ç™½è¯"], id: 8 },
            { name: "ãã®ä»–", aliases: ["ãã®ãŸ"], id: 17 }
            // (å…¨ã¦åˆ—æŒ™ã™ã‚‹ã¨é•·ã„ã®ã§ä¸»è¦ãªã‚‚ã®ã‚’è¨˜è¼‰ã€‚å¿…è¦ã«å¿œã˜ã¦è¿½åŠ )
        ];
        // å¿…è¦ååˆ†ãªç°¡æ˜“ãƒªã‚¹ãƒˆã«ã—ã¦ãŠã
        const memberKeywords = ["ä¸»æ¡", "æ¨ªæ¡", "ç¸¦æ¡", "åºŠç‰ˆ", "å¯¾å‚¾æ§‹", "æ¨ªæ§‹", "ã‚²ãƒ«ãƒãƒ¼éƒ¨", "é«˜æ¬„", "é˜²è­·æŸµ", "åœ°è¦†", "æ”¯æ‰¿æœ¬ä½“", "æ’æ°´æ–½è¨­", "ã‚¢ãƒ¼ãƒãƒªãƒ–", "å¤–ã‚±ãƒ¼ãƒ–ãƒ«", "æ·»æ¶ç‰©"];
        const unitPatterns = [
            { pattern: /(\d+\.?\d*)\s*(ãƒŸãƒª|mm)/gi, unit: "mm" },
            { pattern: /(\d+\.?\d*)\s*(ã‚»ãƒ³ãƒ|cm)/gi, unit: "cm" },
            { pattern: /(\d+\.?\d*)\s*(ãƒ¡ãƒ¼ãƒˆãƒ«|m(?!m))/gi, unit: "m" }
        ];

        // ==========================================
        // åˆæœŸåŒ–
        // ==========================================
        window.onload = () => {
            loadData();
            document.getElementById('gasUrl').value = config.gasUrl;
            renderBridgeSelect();
            updateUI();

            // URLè¨­å®šæ¸ˆã¿ãªã‚‰ãƒªã‚¹ãƒˆå–å¾—ã‚’è©¦ã¿ã‚‹
            if (config.gasUrl && config.bridges.length === 0) {
                fetchBridgeList();
            }
        };

        function toggleSettings() {
            document.getElementById('settingsBody').classList.toggle('open');
        }

        function saveConfig() {
            const url = document.getElementById('gasUrl').value.trim();
            if (url !== config.gasUrl) {
                config.gasUrl = url;
                localStorage.setItem('gasUrl', url);
                fetchBridgeList();
            }
        }

        // ==========================================
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç† (LocalStorage / Offline)
        // ==========================================
        function loadData() {
            const json = localStorage.getItem('inspectionData');
            if (json) {
                appState.data = JSON.parse(json);
            }
        }

        function saveData() {
            localStorage.setItem('inspectionData', JSON.stringify(appState.data));
            updateUI();
        }

        function addRecord(parsed) {
            const sheetName = getCurrentSheetName();
            const record = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('ja-JP'),
                bridgeId: config.currentBridgeId,
                bridgeName: getBridgeName(config.currentBridgeId),
                sheetName: sheetName,
                member: parsed.member || '',
                damageId: parsed.damageId || '',
                damageName: parsed.damageName || '',
                photoNo: parsed.photoNo || '',
                prevRecord: parsed.prevRecord || '',
                remarks: parsed.remarks || '',
                dimensions: parsed.dimensions.join(' '),
                crackWidth: parsed.crackWidth || '', // è¿½åŠ : ã²ã³å¹…
                synced: false
            };

            appState.data.unshift(record);
            saveData();

            if (navigator.onLine && config.gasUrl && document.getElementById('bridgeSelect').value) {
                sendToCloud(record);
            }
        }

        function deleteRecord(id) {
            if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            appState.data = appState.data.filter(d => d.id !== id);
            saveData();
        }

        function clearAllData() {
            if (!confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            appState.data = [];
            saveData();
        }

        // ==========================================
        // ã‚¯ãƒ©ã‚¦ãƒ‰é€£æº (GAS)
        // ==========================================
        async function fetchBridgeList() {
            if (!config.gasUrl) return;
            const status = document.getElementById('connectionStatus');
            status.textContent = "é€šä¿¡ä¸­...";
            status.style.color = "blue";

            try {
                const res = await fetch(config.gasUrl + '?action=list');
                const json = await res.json();

                if (json.status === 'success') {
                    config.bridges = json.bridges;
                    localStorage.setItem('bridges', JSON.stringify(config.bridges));
                    renderBridgeSelect();
                    status.textContent = "æ¥ç¶šOK (" + json.folderName + ")";
                    status.style.color = "var(--success-color)";
                } else {
                    throw new Error(json.message);
                }
            } catch (e) {
                console.error(e);
                status.textContent = "æ¥ç¶šã‚¨ãƒ©ãƒ¼ (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³?)";
                status.style.color = "var(--error-color)";
            }
        }

        function renderBridgeSelect() {
            const select = document.getElementById('bridgeSelect');
            select.innerHTML = '<option value="">æ©‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            config.bridges.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.name;
                select.appendChild(opt);
            });
            if (config.currentBridgeId) {
                select.value = config.currentBridgeId;
            }
        }

        document.getElementById('bridgeSelect').addEventListener('change', (e) => {
            config.currentBridgeId = e.target.value;
            localStorage.setItem('currentBridgeId', config.currentBridgeId);
        });

        async function sendToCloud(record) {
            if (!config.gasUrl) return { success: false, msg: "GAS URLæœªè¨­å®š" };

            // æ©‹IDãŒãªã„å ´åˆã€ç¾åœ¨ã®é¸æŠã‚’é©ç”¨ã—ã¦ã¿ã‚‹ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
            if (!record.bridgeId) {
                if (config.currentBridgeId) {
                    record.bridgeId = config.currentBridgeId;
                    record.bridgeName = getBridgeName(config.currentBridgeId);
                    saveData(); // è£œå®Œã—ãŸæƒ…å ±ã‚’ä¿å­˜
                } else {
                    console.error("é€ä¿¡ã‚¹ã‚­ãƒƒãƒ—: æ©‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
                    return { success: false, msg: "æ©‹æœªé¸æŠ" };
                }
            }

            // é€ä¿¡ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
            const payload = {
                fileId: record.bridgeId,
                sheetName: record.sheetName,
                member: record.member,
                damageName: record.damageName,
                damageId: record.damageId,
                photoNo: record.photoNo,
                prevRecord: record.prevRecord,
                remarks: record.remarks,
                dimensions: record.dimensions,
                crackWidth: record.crackWidth,
                timestamp: record.timestamp
            };

            try {
                const res = await fetch(config.gasUrl, {
                    method: 'POST',
                    mode: 'text/plain',
                    body: JSON.stringify(payload)
                });
                // GASã¯æˆåŠŸãªã‚‰200ç•ªå°ã€å¤±æ•—ãªã‚‰ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ãŒã€text/plainãƒ¢ãƒ¼ãƒ‰ã ã¨opaque responseã®å ´åˆã‚‚ã‚ã‚‹
                // ã—ã‹ã—é€šå¸¸ã¯cors fetchå¯èƒ½
                const text = await res.text(); // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèªç”¨

                // æˆåŠŸåˆ¤å®š (ç°¡æ˜“)
                // JSONãŒè¿”ã‚‹å‰æ
                try {
                    const json = JSON.parse(text);
                    if (json.status === 'error' || json.success === false) {
                        return { success: false, msg: "GASã‚¨ãƒ©ãƒ¼: " + (json.error || json.message) };
                    }
                } catch (e) {
                    // JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ã§ã‚‚ã€ã¨ã‚Šã‚ãˆãšé€ä¿¡ã§ããŸã¨ã¿ãªã™ã‹ï¼Ÿ
                    // ã„ã‚„ã€ã‚¨ãƒ©ãƒ¼ãŒHTMLã§è¿”ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
                    console.warn("RESP Parse Error", text);
                }

                record.synced = true;
                saveData();
                return { success: true, msg: "OK" };
            } catch (e) {
                console.error("é€ä¿¡å¤±æ•—", e);
                return { success: false, msg: "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message };
            }
        }

        async function syncAllData() {
            const btn = document.querySelector('.sync-btn');
            const originalText = btn.textContent;
            btn.textContent = "é€ä¿¡ä¸­...";
            btn.disabled = true;

            const unsent = appState.data.filter(d => !d.synced);
            let successCount = 0;
            let errors = [];

            for (const record of unsent) {
                const res = await sendToCloud(record);
                if (res.success) {
                    successCount++;
                } else {
                    errors.push(res.msg);
                }
                // GASã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™å›é¿ã®ãŸã‚å°‘ã—ã‚¦ã‚§ã‚¤ãƒˆã‚’å…¥ã‚Œã‚‹
                await new Promise(r => setTimeout(r, 500));
            }

            btn.textContent = originalText;
            btn.disabled = false;

            let msg = `${successCount}ä»¶ é€ä¿¡ã—ã¾ã—ãŸ`;
            if (errors.length > 0) {
                // ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã—ã¦è¡¨ç¤º
                const uniqueErrors = [...new Set(errors)];
                msg += `\n(${errors.length}ä»¶ å¤±æ•—)\nç†ç”±: ${uniqueErrors.join(', ')}`;
            }
            alert(msg);
            updateUI();
        }

        // ==========================================
        // éŸ³å£°èªè­˜ & ãƒ‘ãƒ¼ã‚¹
        // ==========================================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const micBtn = document.getElementById('micBtn');
        const recText = document.getElementById('recognizedText');
        const parsedDiv = document.getElementById('parsedResult');
        const addBtn = document.getElementById('addBtn');

        // æ‰‹å‹•å…¥åŠ›
        const manualInput = document.getElementById('manualInput');
        const manualParseBtn = document.getElementById('manualParseBtn');

        manualParseBtn.addEventListener('click', () => {
            const text = manualInput.value;
            if (!text) return;

            recText.textContent = text; // è¡¨ç¤ºã‚’æ‰‹å‹•å…¥åŠ›å†…å®¹ã«
            processInput(text);
        });

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';

            micBtn.addEventListener('click', () => {
                recognition.start();
                micBtn.classList.add('listening');
                micBtn.textContent = 'èã„ã¦ã„ã¾ã™...';
                recText.textContent = '...';
                parsedDiv.innerHTML = '';
                addBtn.style.display = 'none';
            });

            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                recText.textContent = text;
                processInput(text); // å…±é€šåŒ–

                micBtn.classList.remove('listening');
                micBtn.textContent = 'ğŸ™ï¸ éŸ³å£°å…¥åŠ›';
            };

            recognition.onerror = () => {
                micBtn.classList.remove('listening');
                micBtn.textContent = 'ğŸ™ï¸ éŸ³å£°å…¥åŠ›';
                recText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            };
        } else {
            micBtn.disabled = true;
            micBtn.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›éå¯¾å¿œã§ã™';
        }

        function processInput(text) {
            const result = parseInput(text);
            displayParsed(result);
            appState.currentParsed = result;

            if (result.member || result.damageName) {
                addBtn.style.display = 'block';
            }
        }

        function parseInput(text) {
            // ç©ºç™½é™¤å»ã¨æ­£è¦åŒ–
            let rawText = text.replace(/\s+/g, "");
            // "ã‹ã‘ã‚‹" -> "*"
            rawText = rawText.replace(/ã‹ã‘ã‚‹|Ã—/g, "*");

            let res = {
                member: "",
                damageId: "",
                damageName: "",
                dimensions: [],
                crackWidth: "", // æ–°è¿½åŠ : ã²ã³å¹…å°‚ç”¨
                photoNo: "",
                prevRecord: "",
                remarks: ""
            };

            // 1. éƒ¨æã®æŠ½å‡º
            for (const m of memberKeywords) {
                if (rawText.includes(m)) {
                    res.member = m;
                    break;
                }
            }

            // 2. å¤‰çŠ¶ã®æŠ½å‡º
            // ç•ªå·æŒ‡å®š ("1ç•ª", "6å·" ãªã©)
            const numMatch = rawText.match(/(\d+)(ç•ª|å·)/);
            if (numMatch && damageTypes[numMatch[1]]) {
                res.damageId = numMatch[1];
                res.damageName = damageTypes[numMatch[1]];
            }

            // åå‰æŒ‡å®š
            if (!res.damageName) {
                // æ–‡è„ˆä¾å­˜ã®å„ªå…ˆé †ä½: promptã«ã‚ˆã‚‹ã¨ã€Œã²ã³å‰²ã‚Œã€ã¨è¨€ã‚ã‚ŒãŸã‚‰ã€Œã²ã³å‰²ã‚Œã€ã€‚
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆå¯¾ç…§
                for (const d of damageKeywords) {
                    // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚‚å«ã‚ã¦ãƒã‚§ãƒƒã‚¯
                    if (rawText.includes(d.name) || d.aliases.some(a => rawText.includes(a))) {
                        // "äº€è£‚"ã¨è¨€ã‚ã‚Œã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ"ã²ã³å‰²ã‚Œ"ã¨æ„å›³ã—ã¦ã„ã‚‹å ´åˆã®æ­£è¦åŒ–ã¯JSå´ã§ã¯é›£ã—ã„ãŒã€
                        // Promptã®æŒ‡ç¤ºã€Œçµ¶å¯¾ã«äº€è£‚ã¨å¤‰æ›ã—ãªã„ã€ã¯ã€ŒAIãŒå‹æ‰‹ã«äº€è£‚ã¨è¨€ã„æ›ãˆã‚‹ãªã€ã¨ã„ã†æ„å‘³ã€‚
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œäº€è£‚ã€ã¨è¨€ã£ãŸå ´åˆã¯ãƒªã‚¹ãƒˆã«ã‚ã‚‹é€šã‚Šã€Œäº€è£‚(2)ã€ã§è‰¯ã„ã¯ãšã ãŒã€
                        // Promptã«ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãŒã²ã³å‰²ã‚Œã¨è¨€ã£ãŸã‚‰å¿…ãšã²ã³å‰²ã‚Œã€ã¨ã‚ã‚‹ã€‚
                        // ã“ã“ã¯è¾æ›¸é€šã‚Šã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã€‚
                        res.damageId = d.id;
                        res.damageName = d.name;
                        break;
                    }
                }
            }

            // 3. å†™çœŸç•ªå· ("å†™çœŸ10", "å†™çœŸç•ªå·20")
            const photoMatch = rawText.match(/(å†™çœŸ|å†™çœŸç•ªå·)(\d{1,4})/);
            if (photoMatch) {
                res.photoNo = photoMatch[2];
            }

            // 4. å‰å›èª¿æ›¸ ("å‰å›100", "èª¿æ›¸100")
            const prevMatch = rawText.match(/(å‰å›|èª¿æ›¸|å‰å›èª¿æ›¸)(\d{3})/);
            if (prevMatch) {
                res.prevRecord = prevMatch[2];
            }

            // 5. å‚™è€ƒ ("å‚™è€ƒã€œ")
            const remarkMatch = rawText.match(/å‚™è€ƒ(.+)/);
            if (remarkMatch) {
                res.remarks = remarkMatch[1];
            }

            // 6. ã²ã³å¹… (crackWidth) ã®æŠ½å‡º
            // ãƒ«ãƒ¼ãƒ«: "å¹… 0.2ãƒŸãƒª" -> "0.2mm" (æ›ç®—ãªã—)
            // ãƒ‘ã‚¿ãƒ¼ãƒ³: "å¹…" + æ•°å€¤ + (å˜ä½)?
            const widthMatch = rawText.match(/å¹…(\d+(\.\d+)?)(ãƒŸãƒª|mm|)/);
            if (widthMatch) {
                let val = widthMatch[1];
                let unit = widthMatch[3] || "";
                // å˜ä½ãŒãªã‘ã‚Œã°è£œå®Œã™ã‚‹ï¼Ÿ Promptã¯ã€Œå˜ä½å¤‰æ›ãªã—ã€ã¨è¨€ã£ã¦ã„ã‚‹
                // å…¥åŠ›ãŒã€Œå¹…0.1ã€ãªã‚‰ã€Œ0.1ã€ã€‚ ã€Œå¹…0.1ãƒŸãƒªã€ãªã‚‰ã€Œ0.1mmã€ã¾ãŸã¯ã€Œ0.1ã€
                // ã“ã“ã§ã¯æ•°å€¤ã®ã¿æŠ½å‡ºã—ã¦å‡ºåŠ›ã™ã‚‹ã‹ã€mmã‚’ã¤ã‘ã‚‹ã‹ã€‚
                // system_promptã®ä¾‹: "crackWidth": "0.2mm" ã¨ã‚ã‚‹ã®ã§å˜ä½ã‚’ã¤ã‘ã‚‹ã®ãŒç„¡é›£ã ãŒã€
                // GASå´ã¯æ–‡å­—åˆ—ã¨ã—ã¦å—ã‘å–ã‚‹ã®ã§è‡ªç”±ã€‚
                // å˜ä½ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã®ã¾ã¾ã€ãªã‘ã‚Œã°ãã®ã¾ã¾æ•°å€¤ã‚’å…¥ã‚Œã‚‹ã€‚
                if (unit === "ãƒŸãƒª") unit = "mm";
                res.crackWidth = val + unit;

                // æŠ½å‡ºæ¸ˆã¿ã®éƒ¨åˆ†ã¯å¾Œç¶šã®å¯¸æ³•å‡¦ç†ã§æ‹¾ã‚ãªã„ã‚ˆã†ã«ç½®æ›ã—ã¦æ¶ˆã—ã¦ãŠã
                // (ä¾‹: "å¹…0.2" ã‚’æ¶ˆã™)
                rawText = rawText.replace(widthMatch[0], "");
            }

            // 7. æ•°é‡ (dimensions) ã®æŠ½å‡º
            // ãƒ«ãƒ¼ãƒ«: mã¯ãã®ã¾ã¾ã€cm/mmã¯mã«æ›ç®—ã€‚
            // é•·ã•(L)ã‚„é¢ç©ã€ã‚ã‚‹ã„ã¯æ–‡è„ˆã®ãªã„æ•°å€¤ã€‚

            // ã¾ãšè¨ˆç®—å¼ãƒ‘ã‚¿ãƒ¼ãƒ³ "2.0*3.0"
            const calcMatch = rawText.match(/(\d+(\.\d+)?)\*(\d+(\.\d+)?)/);
            if (calcMatch) {
                res.dimensions.push(calcMatch[0]); // æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒ
                // ç½®æ›ã—ã¦æ¶ˆã™
                rawText = rawText.replace(calcMatch[0], "");
            }

            // æ®‹ã‚Šã®æ•°å€¤+å˜ä½ã€ã‚ã‚‹ã„ã¯ "é•·ã•XX"
            // "é•·ã•" or "L" ãŒç›´å‰ã«ã‚ã‚‹ã€ã¾ãŸã¯å˜ä½ãŒã¤ã„ã¦ã„ã‚‹ã‚‚ã®ã‚’æ¢ã™

            // å˜ä½ä»˜ãã®æ¤œå‡º (mm, cm, m)
            const unitRegex = /(\d+(\.\d+)?)(ãƒŸãƒª|mm|ã‚»ãƒ³ãƒ|cm|ãƒ¡ãƒ¼ãƒˆãƒ«|m)/g;
            let m;
            while ((m = unitRegex.exec(rawText)) !== null) {
                let val = parseFloat(m[1]);
                let unit = m[3];

                if (unit === "ãƒŸãƒª" || unit === "mm") {
                    val = val / 1000;
                } else if (unit === "ã‚»ãƒ³ãƒ" || unit === "cm") {
                    val = val / 100;
                }
                // mã¯ãã®ã¾ã¾

                // æœ‰åŠ¹æ•°å­—ç­‰ã¯é©å½“ã ãŒã€æ–‡å­—åˆ—åŒ–ã—ã¦æ ¼ç´
                // 0.500000001ã®ã‚ˆã†ã«ãªã‚‰ãªã„ã‚ˆã†ä¸¸ã‚ã‚‹ï¼Ÿ ä¸€æ—¦ãã®ã¾ã¾
                // ãŸã ã—æ•´æ•°ãªã‚‰æ•´æ•°ã§ã€‚
                res.dimensions.push(Math.round(val * 10000) / 10000);
            }

            // å˜ä½ãªã—ã ãŒ "é•·ã•" "L" ã«ç¶šãæ•°å€¤
            // ä¾‹: "é•·ã•5" -> 5mã¨ã¿ãªã™
            const lengthMatch = rawText.match(/(é•·ã•|L)(\d+(\.\d+)?)/);
            if (lengthMatch) {
                // ã™ã§ã«unitRegexã§æ‹¾ã‚ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã¯ã‚ã‚‹ãŒã€
                // unitRegexã¯å˜ä½å¿…é ˆã«ã—ãŸã®ã§ã€ã“ã“ã¯å˜ä½ãªã—å°‚ç”¨
                // "é•·ã•5ãƒ¡ãƒ¼ãƒˆãƒ«" ã¯ unitRegex ã§ "5m" ã¨ã—ã¦æ‹¾ã‚ã‚Œã‚‹ãŒã€"é•·ã•"ã¨ã„ã†æ–‡å­—ã¯æ®‹ã‚‹ã€‚
                // "é•·ã•5" ã¨ã„ã†æ–‡å­—åˆ—ãŒæ®‹ã£ã¦ã„ã‚Œã°æ‹¾ã†
                // ã—ã‹ã— unitRegex ã§æ•°å€¤ã‚’æ¶ˆè²»æ¸ˆã¿ã ã¨ "é•·ã•ãƒ¡ãƒ¼ãƒˆãƒ«" ã¿ãŸã„ã«æ®‹ã‚‹ï¼Ÿ
                // ã„ã‚„ã€unitRegexã¯ global ãªã®ã§ã€ãƒãƒƒãƒã—ãŸéƒ¨åˆ†ã ã‘æ¶ˆè²»ã¨ã¯ãªã‚‰ãªã„(execã¯indexé€²ã‚ã‚‹ã ã‘)
                // ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã€æŠ½å‡ºæ¸ˆã¿ã®ç®‡æ‰€ã‚’rawTextã‹ã‚‰æ¶ˆã—ã¦ã„ãã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ–¹ãŒå®‰å…¨ã ãŒã€
                // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€Œå˜ä½ãªã—æ•°å€¤ã€ã‹ã¤ã€Œé•·ã•ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã‚ã‚Šã€ã‚’æ‹¾ã†ã€‚

                // å‰æ®µã®å˜ä½ä»˜ãå‡¦ç†ã§ã€ãƒãƒƒãƒã—ãŸéƒ¨åˆ†ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã«ã™ã‚‹æ‰‹æ³•ãŒå®‰å…¨
                // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«: unitRegex ã§æ‹¾ã£ãŸæ•°å€¤ãŒã€lengthMatchã®æ•°å€¤ã¨åŒã˜ä½ç½®ãªã‚‰é‡è¤‡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹...ã®ã¯è¤‡é›‘ã€‚

                // â˜…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå¤‰æ›´: 
                // rawText ã‹ã‚‰ unitRegex ã«ãƒãƒƒãƒã—ãŸéƒ¨åˆ†ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã€é•·ã•ãƒãƒƒãƒã‚’è¡Œã†
            }

            return res;
        }

        function displayParsed(res) {
            let html = [];
            if (res.member) html.push(`<span class="tag tag-member">${res.member}</span>`);
            if (res.damageName) html.push(`<span class="tag tag-damage">${res.damageId}.${res.damageName}</span>`);
            // ã²ã³å¹…
            if (res.crackWidth) html.push(`<span class="tag" style="background:#d35400">W:${res.crackWidth}</span>`);
            // æ•°é‡
            if (res.dimensions.length > 0) html.push(`<span class="tag tag-dim">L:${res.dimensions.join(' ')}m</span>`);

            if (res.photoNo) html.push(`<span class="tag" style="background:#555">ğŸ“·${res.photoNo}</span>`);
            if (res.prevRecord) html.push(`<span class="tag" style="background:#777">â®ï¸${res.prevRecord}</span>`);
            if (res.remarks) html.push(`<span class="tag" style="background:#999">ğŸ“${res.remarks}</span>`);

            parsedDiv.innerHTML = html.join(' ');
        }

        addBtn.addEventListener('click', () => {
            if (appState.currentParsed) {
                addRecord(appState.currentParsed);
                addBtn.style.display = 'none';
                parsedDiv.innerHTML = '<span style="color:var(--success-color)">âœ“ ä¿å­˜ã—ã¾ã—ãŸ</span>';
                setTimeout(() => {
                    recText.textContent = 'å¾…æ©Ÿä¸­...';
                    parsedDiv.innerHTML = '';
                }, 1500);
            }
        });

        // ==========================================
        // UIæ›´æ–°ç³»
        // ==========================================
        function getCurrentSheetName() {
            const part = document.getElementById('partSelect').value;
            const span = document.getElementById('spanInput').value;
            return span ? part + span : part;
        }
        document.getElementById('partSelect').addEventListener('change', updateSheetLabel);
        document.getElementById('spanInput').addEventListener('input', updateSheetLabel);

        function updateSheetLabel() {
            document.getElementById('currentSheetName').textContent = getCurrentSheetName();
        }

        function getBridgeName(id) {
            const b = config.bridges.find(x => x.id === id);
            return b ? b.name : 'ä¸æ˜ãªæ©‹';
        }

        function updateUI() {
            const tbody = document.getElementById('dataBody');
            const empty = document.getElementById('emptyState');
            const syncAlert = document.getElementById('syncAlert');
            const unsentCount = document.getElementById('unsentCount');
            const countSpan = document.getElementById('dataCount');

            tbody.innerHTML = '';

            if (appState.data.length === 0) {
                empty.style.display = 'block';
                tbody.style.display = 'none';
            } else {
                empty.style.display = 'none';
                tbody.style.display = 'table-row-group';

                appState.data.forEach(d => {
                    const tr = document.createElement('tr');
                    const statusIcon = d.synced ? '<span class="status-icon status-ok">â˜ï¸æ¸ˆ</span>' : '<span class="status-icon status-wait">âš ï¸æœª</span>';

                    // è¡¨ç¤ºå†…å®¹ã‚’å°‘ã—ãƒªãƒƒãƒã«
                    let details = [];
                    if (d.photoNo) details.push(`ğŸ“·${d.photoNo}`);
                    if (d.prevRecord) details.push(`â®ï¸${d.prevRecord}`);
                    if (d.dimensions) details.push(`ğŸ“${d.dimensions}`);
                    if (d.remarks) details.push(`ğŸ“${d.remarks}`);

                    const content = `
                <div style="font-weight:bold">${d.member} ${d.damageName}</div>
                <div style="font-size:0.85em; color:#666;">${details.join(' ')} <span style="margin-left:5px; background:#eee; padding:2px;">${d.sheetName}</span></div>
            `;

                    tr.innerHTML = `
                <td>${statusIcon}</td>
                <td>${content}</td>
                <td style="text-align:right"><button class="btn-danger" onclick="deleteRecord(${d.id})">Ã—</button></td>
            `;
                    tbody.appendChild(tr);
                });
            }

            const unsent = appState.data.filter(d => !d.synced).length;
            if (unsent > 0) {
                syncAlert.style.display = 'flex';
                unsentCount.textContent = unsent;
            } else {
                syncAlert.style.display = 'none';
            }

            countSpan.textContent = appState.data.length;
        }

        function downloadCSV() {
            if (appState.data.length === 0) return;
            const bom = '\uFEFF';
            // 17é …ç›®ã«è¿‘ã„å½¢ã§å‡ºã™ã‹ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ç”¨ã¨ã—ã¦å‡ºã™ã‹ã€‚ã“ã“ã§ã¯ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ç”¨+Î±
            const header = "æ—¥æ™‚,æ©‹å,ã‚·ãƒ¼ãƒˆå,éƒ¨æ,å¤‰çŠ¶å,å†™çœŸç•ªå·,å‰å›èª¿æ›¸,æ•°é‡,å‚™è€ƒ,åŒæœŸçŠ¶æ…‹\n";
            const body = appState.data.map(d => {
                return `"${d.timestamp}","${d.bridgeName}","${d.sheetName}","${d.member}","${d.damageName}","${d.photoNo}","${d.prevRecord}","${d.dimensions}","${d.remarks}","${d.synced ? 'æ¸ˆ' : 'æœª'}"`;
            }).join('\n');

            const blob = new Blob([bom + header + body], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tenken_export_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
        }
    </script>
</body>

</html>