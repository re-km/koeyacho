<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©‹æ¢ç‚¹æ¤œ éŸ³å£°å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ </title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            /* é…è‰²ãƒ†ãƒ¼ãƒï¼ˆVS Code Lightç³»ï¼‰ */
            --bg-color: #f3f3f3;
            --text-color: #333333;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --accent-color: #007acc;
            /* VS Code Blue */
            --accent-hover: #005f9e;
            --success-color: #16825d;
            --warning-color: #ea5c00;
            --error-color: #d13438;
            --sub-text: #666666;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 1.2em;
            color: var(--text-color);
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* å…±é€šã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        /* è¨­å®šã‚«ãƒ¼ãƒ‰ï¼ˆé–‹é–‰å¼ï¼‰ */
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 5px 0;
        }

        .settings-title {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--sub-text);
        }

        .settings-body {
            display: none;
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .settings-body.open {
            display: block;
        }

        .input-text {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
            margin-bottom: 10px;
            background: #fafafa;
        }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        button {
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }

        button:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            padding: 8px 16px;
            font-weight: 600;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            font-weight: 600;
        }

        .btn-danger {
            background: #fff;
            border: 1px solid var(--error-color);
            color: var(--error-color);
            padding: 4px 8px;
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 12px;
        }

        /* ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ */
        .select-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        select,
        input[type="number"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #fff;
            color: var(--text-color);
            font-size: 1em;
        }

        .flex-grow {
            flex: 1;
        }

        /* ã‚·ãƒ¼ãƒˆè¡¨ç¤º */
        .sheet-badge {
            display: inline-block;
            background: #e1f0fa;
            color: var(--accent-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* éŸ³å£°å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-card {
            text-align: center;
            border-left: 4px solid var(--accent-color);
        }

        .mic-btn {
            width: 100%;
            padding: 20px;
            background: var(--accent-color);
            color: white;
            font-size: 1.2em;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 122, 204, 0.2);
        }

        .mic-btn.listening {
            background: var(--error-color);
            box-shadow: 0 0 15px rgba(209, 52, 56, 0.4);
        }

        .result-box {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .recognized-text {
            color: var(--sub-text);
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .parsed-result {
            font-weight: bold;
            font-size: 1.1em;
        }

        .parsed-info span {
            margin: 0 5px;
        }

        .tag {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            color: white;
        }

        .tag-member {
            background: #444;
        }

        .tag-damage {
            background: var(--accent-color);
        }

        .tag-dim {
            background: var(--success-color);
        }

        /* ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
        }

        .list-title {
            font-weight: 600;
            font-size: 1em;
        }

        /* åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .sync-alert {
            background: #fff4e5;
            border: 1px solid var(--warning-color);
            color: #663c00;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            display: none;
            /* åˆæœŸéè¡¨ç¤º */
        }

        .sync-btn {
            background: var(--warning-color);
            color: white;
            font-size: 0.9em;
            padding: 6px 12px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            text-align: left;
            color: var(--sub-text);
            font-weight: normal;
            font-size: 0.8em;
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 8px 5px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .status-icon {
            font-size: 0.8em;
            margin-right: 4px;
        }

        .status-ok {
            color: var(--success-color);
        }

        .status-wait {
            color: var(--warning-color);
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer {
            text-align: center;
            color: var(--sub-text);
            font-size: 0.75em;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>koeyacho</h1>

    <!-- æœªé€ä¿¡ã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div id="syncAlert" class="sync-alert">
        <span>âš ï¸ æœªé€ä¿¡ãƒ‡ãƒ¼ã‚¿: <strong id="unsentCount">0</strong>ä»¶</span>
        <button class="sync-btn" onclick="syncAllData()">ã‚¯ãƒ©ã‚¦ãƒ‰ã«åŒæœŸ</button>
    </div>

    <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
    <div class="card">
        <div class="settings-header" onclick="toggleSettings()">
            <span class="settings-title">âš™ï¸ è¨­å®š (GAS URL & æ©‹é¸æŠ)</span>
            <span style="font-size:0.8em">â–¼</span>
        </div>
        <div class="settings-body" id="settingsBody">
            <label style="font-size:0.8em; display:block; margin-bottom:5px;">GAS Web App URL</label>
            <input type="text" class="input-text" id="gasUrl" placeholder="https://script.google.com/..."
                onchange="saveConfig()">
            <div style="font-size:0.8em; color:var(--sub-text); margin-top:5px;">
                æ©‹ãƒªã‚¹ãƒˆå–å¾—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="connectionStatus">æœªæ¥ç¶š</span>
            </div>
        </div>
    </div>

    <!-- æ©‹ãƒ»å ´æ‰€é¸æŠ -->
    <div class="card">
        <div class="select-row">
            <select id="bridgeSelect" class="flex-grow">
                <option value="">æ©‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <button class="btn-outline" onclick="fetchBridgeList()">ğŸ”„</button>
        </div>
        <div class="select-row">
            <select id="partSelect" class="flex-grow">
                <option value="ä¸‹é¢">ä¸‹é¢</option>
                <option value="ä¸‹éƒ¨å·¥">ä¸‹éƒ¨å·¥</option>
                <option value="æ”¯æ‰¿éƒ¨">æ”¯æ‰¿éƒ¨</option>
                <option value="æ©‹é¢">æ©‹é¢</option>
                <option value="ãƒˆãƒ©ã‚¹ãƒ»ã‚¢ãƒ¼ãƒ">ãƒˆãƒ©ã‚¹ãƒ»ã‚¢ãƒ¼ãƒ</option>
            </select>
            <input type="number" id="spanInput" placeholder="å¾„é–“" style="width: 80px;">
        </div>
        <div style="text-align:right;">
            <span class="sheet-badge">Sheet: <span id="currentSheetName">ä¸‹é¢</span></span>
        </div>
    </div>

    <!-- éŸ³å£°å…¥åŠ› -->
    <div class="card input-card">
        <div class="result-box">
            <div id="recognizedText" class="recognized-text">å¾…æ©Ÿä¸­...</div>
            <div id="parsedResult" class="parsed-result"></div>
        </div>
        <button id="micBtn" class="mic-btn">ğŸ™ï¸ éŸ³å£°å…¥åŠ›</button>
        <button id="addBtn" class="btn-success" style="width:100%; display:none;">âœ“ è¨˜éŒ²ã™ã‚‹</button>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ -->
    <div class="card">
        <div class="list-header">
            <span class="list-title">è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ (<span id="dataCount">0</span>)</span>
            <div>
                <button class="btn-outline" style="font-size:0.8em" onclick="downloadCSV()">CSV</button>
                <button class="btn-outline" style="font-size:0.8em; color:var(--error-color);"
                    onclick="clearAllData()">ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
        <div class="table-container">
            <table id="dataTable">
                <tbody id="dataBody"></tbody>
            </table>
            <div id="emptyState" style="text-align:center; padding:20px; color:var(--sub-text);">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
        </div>
    </div>

    <div class="footer" id="systemStatus">Ready</div>

    <script>
        // ==========================================
        // ã‚³ãƒ³ãƒ•ã‚£ã‚° & ã‚¹ãƒ†ãƒ¼ãƒˆ
        // ==========================================
        let config = {
            gasUrl: localStorage.getItem('gasUrl') || '',
            bridges: JSON.parse(localStorage.getItem('bridges') || '[]'),
            currentBridgeId: localStorage.getItem('currentBridgeId') || ''
        };

        let appState = {
            data: [], // { id, timestamp, bridgeId, sheetName, content, ... , synced: boolean }
            currentParsed: null
        };

        // ==========================================
        // è¾æ›¸ãƒ‡ãƒ¼ã‚¿ (å¤‰æ›´ãªã—)
        // ==========================================
        const damageTypes = {
            1: "è…é£Ÿ", 2: "äº€è£‚", 3: "ã‚†ã‚‹ã¿ãƒ»è„±è½", 4: "ç ´æ–­", 5: "é˜²é£Ÿæ©Ÿèƒ½ã®åŠ£åŒ–", 6: "ã²ã³ã‚ã‚Œ", 7: "å‰¥é›¢ãƒ»é‰„ç­‹éœ²å‡º", 8: "æ¼æ°´ãƒ»éŠé›¢çŸ³ç°", 9: "æŠœã‘è½ã¡", 10: "è£œä¿®è£œå¼·æã®æå‚·", 11: "åºŠç‰ˆã²ã³ã‚ã‚Œ", 12: "ã†ã", 13: "éŠé–“ã®ç•°å¸¸", 14: "è·¯é¢ã®å‡¹å‡¸", 15: "èˆ—è£…ã®ç•°å¸¸", 16: "æ”¯æ‰¿éƒ¨ã®æ©Ÿèƒ½éšœå®³", 17: "ãã®ä»–", 18: "å®šç€éƒ¨ã®ç•°å¸¸", 19: "å¤‰è‰²ãƒ»åŠ£åŒ–", 20: "æ¼æ°´ãƒ»æ»æ°´", 21: "ç•°å¸¸ãªéŸ³ãƒ»æŒ¯å‹•", 22: "ç•°å¸¸ãªãŸã‚ã¿", 23: "å¤‰å½¢ãƒ»æ¬ æ", 24: "åœŸç ‚è©°ã¾ã‚Š", 25: "æ²ˆä¸‹ãƒ»ç§»å‹•ãƒ»å‚¾æ–œ", 26: "æ´—æ˜"
        };
        const damageKeywords = [
            { name: "è…é£Ÿ", aliases: ["ãµã—ã‚‡ã", "ã‚µãƒ“", "éŒ†", "ã•ã³"], id: 1 },
            { name: "äº€è£‚", aliases: ["ãã‚Œã¤", "ã‚¯ãƒ©ãƒƒã‚¯", "ã‚ã‚Œ", "å‰²ã‚Œ"], id: 2 },
            { name: "ã²ã³ã‚ã‚Œ", aliases: ["ã²ã³å‰²ã‚Œ", "ã‚¯ãƒ©ãƒƒã‚¯", "ã²ã³", "ãƒ’ãƒ“"], id: 6 },
            { name: "ã†ã", aliases: ["æµ®ã", "ã‚¦ã‚­"], id: 12 },
            { name: "å‰¥é›¢ãƒ»é‰„ç­‹éœ²å‡º", aliases: ["ã¯ãã‚Š", "å‰¥é›¢", "é‰„ç­‹éœ²å‡º", "éœ²å‡º"], id: 7 },
            { name: "éŠé–“ã®ç•°å¸¸", aliases: ["ã‚†ã†ã‹ã‚“", "éŠé–“", "ã™ãã¾"], id: 13 },
            { name: "æ¼æ°´ãƒ»éŠé›¢çŸ³ç°", aliases: ["ã‚ã†ã™ã„", "æ¼æ°´", "éŠé›¢çŸ³ç°", "ã‚¨ãƒ•ãƒ­", "ç™½è¯"], id: 8 },
            { name: "ãã®ä»–", aliases: ["ãã®ãŸ"], id: 17 }
            // (å…¨ã¦åˆ—æŒ™ã™ã‚‹ã¨é•·ã„ã®ã§ä¸»è¦ãªã‚‚ã®ã‚’è¨˜è¼‰ã€‚å¿…è¦ã«å¿œã˜ã¦è¿½åŠ )
        ];
        // å¿…è¦ååˆ†ãªç°¡æ˜“ãƒªã‚¹ãƒˆã«ã—ã¦ãŠã
        const memberKeywords = ["ä¸»æ¡", "æ¨ªæ¡", "ç¸¦æ¡", "åºŠç‰ˆ", "å¯¾å‚¾æ§‹", "æ¨ªæ§‹", "ã‚²ãƒ«ãƒãƒ¼éƒ¨", "é«˜æ¬„", "é˜²è­·æŸµ", "åœ°è¦†", "æ”¯æ‰¿æœ¬ä½“", "æ’æ°´æ–½è¨­", "ã‚¢ãƒ¼ãƒãƒªãƒ–", "å¤–ã‚±ãƒ¼ãƒ–ãƒ«", "æ·»æ¶ç‰©"];
        const unitPatterns = [
            { pattern: /(\d+\.?\d*)\s*(ãƒŸãƒª|mm)/gi, unit: "mm" },
            { pattern: /(\d+\.?\d*)\s*(ã‚»ãƒ³ãƒ|cm)/gi, unit: "cm" },
            { pattern: /(\d+\.?\d*)\s*(ãƒ¡ãƒ¼ãƒˆãƒ«|m(?!m))/gi, unit: "m" }
        ];

        // ==========================================
        // åˆæœŸåŒ–
        // ==========================================
        window.onload = () => {
            loadData();
            document.getElementById('gasUrl').value = config.gasUrl;
            renderBridgeSelect();
            updateUI();

            // URLè¨­å®šæ¸ˆã¿ãªã‚‰ãƒªã‚¹ãƒˆå–å¾—ã‚’è©¦ã¿ã‚‹
            if (config.gasUrl && config.bridges.length === 0) {
                fetchBridgeList();
            }
        };

        function toggleSettings() {
            document.getElementById('settingsBody').classList.toggle('open');
        }

        function saveConfig() {
            const url = document.getElementById('gasUrl').value.trim();
            if (url !== config.gasUrl) {
                config.gasUrl = url;
                localStorage.setItem('gasUrl', url);
                fetchBridgeList();
            }
        }

        // ==========================================
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç† (LocalStorage / Offline)
        // ==========================================
        function loadData() {
            const json = localStorage.getItem('inspectionData');
            if (json) {
                appState.data = JSON.parse(json);
            }
        }

        function saveData() {
            localStorage.setItem('inspectionData', JSON.stringify(appState.data));
            updateUI();
        }

        function addRecord(parsed) {
            const sheetName = getCurrentSheetName();
            const record = {
                id: Date.now(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
                timestamp: new Date().toLocaleString('ja-JP'),
                bridgeId: config.currentBridgeId,
                bridgeName: getBridgeName(config.currentBridgeId),
                sheetName: sheetName,
                member: parsed.member || '',
                damageId: parsed.damageId || '',
                damageName: parsed.damageName || '',
                dimensions: parsed.dimensions.map(d => `${d.value}${d.unit}`).join('Ã—'),
                synced: false // æœªé€ä¿¡çŠ¶æ…‹
            };

            appState.data.unshift(record); // æ–°ã—ã„é †
            saveData();

            // å³æ™‚é€ä¿¡ã‚’è©¦ã¿ã‚‹
            if (navigator.onLine && config.gasUrl && document.getElementById('bridgeSelect').value) {
                sendToCloud(record);
            }
        }

        function deleteRecord(id) {
            if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            appState.data = appState.data.filter(d => d.id !== id);
            saveData();
        }

        function clearAllData() {
            if (!confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            appState.data = [];
            saveData();
        }

        // ==========================================
        // ã‚¯ãƒ©ã‚¦ãƒ‰é€£æº (GAS)
        // ==========================================
        async function fetchBridgeList() {
            if (!config.gasUrl) return;
            const status = document.getElementById('connectionStatus');
            status.textContent = "é€šä¿¡ä¸­...";
            status.style.color = "blue";

            try {
                // GASã‹ã‚‰ãƒªã‚¹ãƒˆå–å¾— (GET)
                const res = await fetch(config.gasUrl + '?action=list');
                const json = await res.json();

                if (json.status === 'success') {
                    config.bridges = json.bridges;
                    localStorage.setItem('bridges', JSON.stringify(config.bridges));
                    renderBridgeSelect();
                    status.textContent = "æ¥ç¶šOK (" + json.folderName + ")";
                    status.style.color = "var(--success-color)";
                } else {
                    throw new Error(json.message);
                }
            } catch (e) {
                console.error(e);
                status.textContent = "æ¥ç¶šã‚¨ãƒ©ãƒ¼ (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³?)";
                status.style.color = "var(--error-color)";
            }
        }

        function renderBridgeSelect() {
            const select = document.getElementById('bridgeSelect');
            select.innerHTML = '<option value="">æ©‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            config.bridges.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.name;
                select.appendChild(opt);
            });
            if (config.currentBridgeId) {
                select.value = config.currentBridgeId;
            }
        }

        document.getElementById('bridgeSelect').addEventListener('change', (e) => {
            config.currentBridgeId = e.target.value;
            localStorage.setItem('currentBridgeId', config.currentBridgeId);
        });

        async function sendToCloud(record) {
            if (!config.gasUrl || !record.bridgeId) return;

            // é€ä¿¡ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰ (æ—§APIäº’æ›)
            const payload = {
                fileId: record.bridgeId,
                sheetName: record.sheetName,
                id: "", // ã‚¹ãƒ—ã‚·ä¸Šã®Noã¯è‡ªå‹•æ¡ç•ªã«ãŠä»»ã›ã§ã‚‚ã‚ˆã„ãŒã€ç©ºã§ãŠãã‚‹
                member: record.member,
                damageId: record.damageId,
                damageName: record.damageName,
                dimensions: record.dimensions,
                timestamp: record.timestamp
            };

            try {
                const res = await fetch(config.gasUrl, {
                    method: 'POST',
                    mode: 'text/plain', // GASã®CORSå›é¿å®šçŸ³
                    body: JSON.stringify(payload)
                });

                // æˆåŠŸã—ãŸã‚‰ãƒ•ãƒ©ã‚°æ›´æ–°
                record.synced = true;
                saveData();
                return true;
            } catch (e) {
                console.error("é€ä¿¡å¤±æ•—", e);
                return false;
            }
        }

        async function syncAllData() {
            const btn = document.querySelector('.sync-btn');
            const originalText = btn.textContent;
            btn.textContent = "é€ä¿¡ä¸­...";
            btn.disabled = true;

            const unsent = appState.data.filter(d => !d.synced);
            let successCount = 0;

            for (const record of unsent) {
                // æ©‹ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ãªã©ã¯é€ã‚Œãªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—ç­‰ã®å‡¦ç†ãŒå¿…è¦ã ãŒã€
                // ä»Šå›ã¯bridgeIdãŒã‚ã‚Œã°é€ã‚‹
                if (record.bridgeId) {
                    const result = await sendToCloud(record);
                    if (result) successCount++;
                    // GASã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™å›é¿ã®ãŸã‚å°‘ã—ã‚¦ã‚§ã‚¤ãƒˆã‚’å…¥ã‚Œã‚‹
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            btn.textContent = originalText;
            btn.disabled = false;

            alert(`${successCount}ä»¶ é€ä¿¡ã—ã¾ã—ãŸ`);
            updateUI();
        }

        // ==========================================
        // éŸ³å£°èªè­˜ & ãƒ‘ãƒ¼ã‚¹
        // ==========================================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const micBtn = document.getElementById('micBtn');
        const recText = document.getElementById('recognizedText');
        const parsedDiv = document.getElementById('parsedResult');
        const addBtn = document.getElementById('addBtn');

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';

            micBtn.addEventListener('click', () => {
                recognition.start();
                micBtn.classList.add('listening');
                micBtn.textContent = 'èã„ã¦ã„ã¾ã™...';
                recText.textContent = '...';
                parsedDiv.innerHTML = '';
                addBtn.style.display = 'none';
            });

            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                recText.textContent = text;
                const result = parseInput(text);
                displayParsed(result);
                appState.currentParsed = result;

                micBtn.classList.remove('listening');
                micBtn.textContent = 'ğŸ™ï¸ éŸ³å£°å…¥åŠ›';

                if (result.member || result.damageName) {
                    addBtn.style.display = 'block';
                }
            };

            recognition.onerror = () => {
                micBtn.classList.remove('listening');
                micBtn.textContent = 'ğŸ™ï¸ éŸ³å£°å…¥åŠ›';
                recText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            };
        } else {
            micBtn.disabled = true;
            micBtn.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›éå¯¾å¿œã§ã™';
        }

        function parseInput(text) {
            text = text.replace(/\s+/g, "");
            let res = { member: "", damageId: "", damageName: "", dimensions: [] };

            // éƒ¨æ
            for (const m of memberKeywords) {
                if (text.includes(m)) { res.member = m; break; }
            }
            // å¤‰çŠ¶(ç•ªå·)
            const num = text.match(/(\d+)(ç•ª|å·)/);
            if (num && damageTypes[num[1]]) {
                res.damageId = num[1]; res.damageName = damageTypes[num[1]];
            }
            // å¤‰çŠ¶(åå‰)
            if (!res.damageName) {
                for (const d of damageKeywords) {
                    if (text.includes(d.name) || d.aliases.some(a => text.includes(a))) {
                        res.damageId = d.id; res.damageName = d.name; break;
                    }
                }
            }
            // å¯¸æ³•
            for (const p of unitPatterns) {
                const matches = [...text.matchAll(p.pattern)];
                matches.forEach(m => res.dimensions.push({ value: m[1], unit: p.unit }));
            }
            return res;
        }

        function displayParsed(res) {
            let html = [];
            if (res.member) html.push(`<span class="tag tag-member">${res.member}</span>`);
            if (res.damageName) html.push(`<span class="tag tag-damage">${res.damageId}.${res.damageName}</span>`);
            res.dimensions.forEach(d => html.push(`<span class="tag tag-dim">${d.value}${d.unit}</span>`));
            parsedDiv.innerHTML = html.join(' ');
        }

        addBtn.addEventListener('click', () => {
            if (appState.currentParsed) {
                addRecord(appState.currentParsed);
                addBtn.style.display = 'none';
                parsedDiv.innerHTML = '<span style="color:var(--success-color)">âœ“ ä¿å­˜ã—ã¾ã—ãŸ</span>';
                setTimeout(() => {
                    recText.textContent = 'å¾…æ©Ÿä¸­...';
                    parsedDiv.innerHTML = '';
                }, 1500);
            }
        });

        // ==========================================
        // UIæ›´æ–°ç³»
        // ==========================================
        function getCurrentSheetName() {
            const part = document.getElementById('partSelect').value;
            const span = document.getElementById('spanInput').value;
            return span ? part + span : part;
        }
        document.getElementById('partSelect').addEventListener('change', updateSheetLabel);
        document.getElementById('spanInput').addEventListener('input', updateSheetLabel);

        function updateSheetLabel() {
            document.getElementById('currentSheetName').textContent = getCurrentSheetName();
        }

        function getBridgeName(id) {
            const b = config.bridges.find(x => x.id === id);
            return b ? b.name : 'ä¸æ˜ãªæ©‹';
        }

        function updateUI() {
            const tbody = document.getElementById('dataBody');
            const empty = document.getElementById('emptyState');
            const syncAlert = document.getElementById('syncAlert');
            const unsentCount = document.getElementById('unsentCount');
            const countSpan = document.getElementById('dataCount');

            tbody.innerHTML = '';

            if (appState.data.length === 0) {
                empty.style.display = 'block';
                tbody.style.display = 'none';
            } else {
                empty.style.display = 'none';
                tbody.style.display = 'table-row-group';

                appState.data.forEach(d => {
                    const tr = document.createElement('tr');
                    const statusIcon = d.synced ? '<span class="status-icon status-ok">â˜ï¸æ¸ˆ</span>' : '<span class="status-icon status-wait">âš ï¸æœª</span>';
                    const content = `
                <div style="font-weight:bold">${d.member} ${d.damageName}</div>
                <div style="font-size:0.85em; color:#666;">${d.dimensions} <span style="margin-left:5px; background:#eee; padding:2px;">${d.sheetName}</span></div>
            `;

                    tr.innerHTML = `
                <td>${statusIcon}</td>
                <td>${content}</td>
                <td style="text-align:right"><button class="btn-danger" onclick="deleteRecord(${d.id})">Ã—</button></td>
            `;
                    tbody.appendChild(tr);
                });
            }

            const unsent = appState.data.filter(d => !d.synced).length;
            if (unsent > 0) {
                syncAlert.style.display = 'flex';
                unsentCount.textContent = unsent;
            } else {
                syncAlert.style.display = 'none';
            }

            countSpan.textContent = appState.data.length;
        }

        function downloadCSV() {
            if (appState.data.length === 0) return;
            const bom = '\uFEFF';
            const header = "æ—¥æ™‚,æ©‹å,ã‚·ãƒ¼ãƒˆå,éƒ¨æ,å¤‰çŠ¶ID,å¤‰çŠ¶å,å¯¸æ³•,åŒæœŸçŠ¶æ…‹\n";
            const body = appState.data.map(d => {
                return `"${d.timestamp}","${d.bridgeName}","${d.sheetName}","${d.member}","${d.damageId}","${d.damageName}","${d.dimensions}","${d.synced ? 'æ¸ˆ' : 'æœª'}"`;
            }).join('\n');

            const blob = new Blob([bom + header + body], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tenken_export_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
        }
    </script>
</body>

</html>